<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.prj.mapper.WithdrawMapper">
	
	<!-- 출금신청 내용 불러오기  -->
	<select id="getList" resultType="org.prj.domain.WithdrawVO">
		select m_idx, w_idx, id, name, phone, with_method, with_amount, with_status, commission, reg_date
		from(
		select ROWNUM rn, m_idx, w_idx, id, name, phone, with_method, with_amount, with_status, commission, reg_date
		from(select * from withdraw order by w_idx desc) order by w_idx desc) where m_idx = #{m_idx }
	</select>

	<!-- 출금신청  -->
	<insert id="insert" parameterType="org.prj.domain.WithdrawVO">
			insert into withdraw( m_idx, w_idx, id, name, phone, with_method, 
                  				  with_amount, with_status, commission, reg_date, note)
			values(#{m_idx }, SEQ_WITHDRAW.nextval, #{id }, #{name }, #{phone }, #{with_method },
       				 #{with_amount }, #{with_status }, 1000, sysdate, #{note })
	</insert>
	
	<!-- p_idx를 가지고와 판매 총액을 확인 -->
	<select id="getp_idx" parameterType="String" resultType="int">
		select sum(service_amount) from payment where p_idx in (
			select p_idx from party_board where id = #{username } )
	</select>
	
	<!-- 지금 요청 금액 -->
	<select id="withamount" parameterType="String" resultType="int">
		select sum(with_amount) from withdraw where m_idx = 
		(select m_idx from member where id=#{username})
		and with_status  = 'A'
	</select>
	
	<!-- 관리자 화면에서 출금신청 리스트 전체를 가지고 오는 것 -->
	<select id="withdrawList" resultType="org.prj.domain.WithdrawVO">
		select * from withdraw order by reg_date desc
	</select>
	
	<!-- 지금  금액은 with_status가 B로 변경된 값만 가지고 오면 된다.  -->
	<select id="currentamount" parameterType="String" resultType="int">
		select sum(with_amount) from withdraw where m_idx = 
		(select m_idx from member where id=#{username})
		and with_status  = 'B'
	</select>
	
	<!-- 관리자 화면에서 승인 버튼 누를 경우 with_status B로 변경  -->
	<update id="modifyWithdraw" parameterType="int">
		update withdraw
		set
			with_status = 'B'
		where w_idx = #{w_idx }
	</update>
	
	
</mapper>